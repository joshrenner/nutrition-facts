<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<script src="../lodash/lodash.js"></script>


<dom-module id="nutrition-facts">
	<style>
		:host {
			--nutrition-facts-label-background: white;
			--nutrition-facts-label-color: black;
			display: table;
			box-sizing: border-box;
			border: var(--nutrition-facts-label-color) solid 1pt;
			font: 8pt/1.4 Helvetica, 'Helvetica Black', san-serif;
			padding: 3pt 0;
			color: var(--nutrition-facts-label-color);
			background: var(--nutrition-facts-label-background);
		}

		h1, p, hr, table {
			margin: 0;
		}

		hr {
			box-sizing: content-box;
			border: var(--nutrition-facts-label-color) solid 0;
			border-top-width: 1pt;
			font-size: 0 !important;
			line-height: 0 !important;
		}
		hr.hr-1 {
			border-top-width: 7pt;
		}
		hr.hr-2 {
			border-top-width: 3pt;
		}

		table {
			border-spacing: 0;
			width: 100%;
		}
		table td {
			padding: 0;
		}

		.x-right {
			text-align: right;
		}
		.x-label {
			font-weight: 700;
		}
		.x-block {
			margin: 0 3pt;
		}
		.x-block .x-block {
			margin-right: 0;
			margin-left: 1em;
		}
		.x-strong {
			font-family: 'Helvetica Black', 'Franklin Gothic Heavy', 'Helvetica', sans-serif;
			font-weight: 900;
		}

		#servings .x-strong {
			font-size: 13pt;
		}
		#perServingLabel {
			font-size: 6pt;
			line-height: 1.6;
			margin-top: 2pt;
		}
		#dailyValueLabel {
			text-align: right;
			font-size: 6pt;
		}
	</style>

	<template>
		<iron-ajax
				id="dailyReferenceValues"
				url=""
				handle-as="json"
				on-response="hresponse"
				debounce-duration="300">
		</iron-ajax>

		<header id="servings" class="x-block">
			<h1 class="x-strong">Nutrition Facts</h1>
			<p class="servingSize">
				<span class="key">Serving Size</span>
				<span class="value">{{data.servingSize}}</span>
			</p>
			<p class="servingsPerContainer">
				<span class="key">Servings Per Container</span>
				<span class="value">{{data.servingsPerContainer}}</span>
			</p>
		</header>
		<hr class="hr-1 x-block">
		<div id="perServingLabel" class="x-block">
			<p class="x-strong">Amount Per Serving</p>
			<hr>
		</div>
		<div id="calories" class="x-block">
			<table><tr>
				<td>
					<span class="key x-label">Calories</span>
					<span class="value">{{calories.amount}}</span>
				</td>
				<td>&nbsp; &nbsp;</td>
				<td class="x-right">
					<span class="key">Calories from Fat</span>
					<span class="value">{{caloriesFromFat.amount}}</span>
				</td>
			</tr></table>
		</div>
		<hr class="hr-2 x-block">
		<div id="dailyValueLabel" class="x-block">
			<p>&#37; Daily Value<sup>&#42;</sup></p>
		</div>
		<div id="nutrients" class="x-block">
			<div id="fat">
				<div id="totalFat">
					<hr>
					<span class="key x-strong">Total Fat</span>
					<span class="value">{{totalFat.amount}}</span>
				</div>
				<div id="saturatedFat" class="x-block" hidden="{{!saturatedFat}}">
					<hr>
					<span class="key">Saturated Fat</span>
					<span class="value">{{saturatedFat.amount}}</span>
				</div>
				<div id="transFat" class="x-block" hidden="{{!transFat}}">
					<hr>
					<span class="key"><em>Trans</em> Fat</span>
					<span class="value">{{transFat.amount}}</span>
				</div>
			</div>
			<div id="cholesterol" hidden="{{!cholesterol}}">
				<hr>
				<span class="key x-strong">Cholesterol</span>
				<span class="value">{{cholesterol.amount}}</span>
			</div>
			<div id="sodium">
				<hr>
				<span class="key x-strong">Sodium</span>
				<span class="value">{{sodium.amount}}</span>
			</div>
			<div id="carbohydrates">
				<div id="totalCarbohydrates">
					<hr>
					<span class="key x-strong">Total Carbohydrate</span>
					<span class="value">{{carbohydrate.amount}}</span>
				</div>
				<div id="dietaryCarbohydrates" class="x-block" hidden="{{!dietaryFiber}}">
					<hr>
					<span class="key">Dietary Fiber</span>
					<span class="value">{{dietaryFiber.amount}}</span>
				</div>
				<div id="sugarsCarbohydrates" class="x-block" hidden="{{!sugars}}">
					<hr>
					<span class="key">Sugars</span>
					<span class="value">{{sugars.amount}}</span>
				</div>
			</div>
			<div id="protein" hidden="{{!protein}}">
				<hr>
				<span class="key x-strong">Protein</span>
				<span class="value">{{protein.amount}}</span>
			</div>
		</div>
		<hr class="hr-1 x-block">
		<div id="vitamins" class="x-block">
			<table><tr>
				<td>
					<span class="key">Vitamin A</span>
				</td>
				<td class="x-right">
					<span class="value">{{vitaminA.amount}}</span>
				</td>
				<td>&nbsp;&#8226;&nbsp;</td>
				<td>
					<span class="key">Vitamin C</span>
				</td>
				<td class="x-right">
					<span class="value">{{vitaminC.amount}}</span>
				</td>
			</tr><tr>
				<td>
					<span class="key">Calcium</span>
				</td>
				<td class="x-right">
					<span class="value">{{calcium.amount}}</span>
				</td>
				<td>&nbsp;&#8226;&nbsp;</td>
				<td>
					<span class="key">Iron</span>
				</td>
				<td class="x-right">
					<span class="value">{{iron.amount}}</span>
				</td>
			</tr></table>
		</div>
	</template>
	<script>
		Polymer({
			is: 'nutrition-facts',
			properties: {
				/**
				 * Describes the nutrition facts of the element as JSON.
				 *
				 * @type {{servingSize: string, servingsPerContainer: number|string, calories: number, caloriesFromFat: number}}
				 */
				data: {
					type: Object,
					value: function() {
						return {};
					}
				},
				servingSize: {
					type: String,
					readOnly: true
				},
				servingsPerContainer: {
					type: Number,
					readOnly: true
				},
				calories: {
					type: Number,
					computed: "getNutrientValue(data.calories)"
				},
				caloriesFromFat: {
					type: Number,
					computed: "getNutrientValue(data.caloriesFromFat)"
				},
				totalFat: {
					type: Number,
					computed: "getNutrientValue(data.totalFat)"
				},
				saturatedFat: {
					type: Number,
					computed: "getNutrientValue(data.saturatedFat)"
				},
				transFat: {
					type: Number,
					computed: "getNutrientValue(data.transFat)"
				},
				cholesterol: {
					type: Number,
					computed: "getNutrientValue(data.cholesterol)"
				},
				sodium: {
					type: Number,
					computed: "getNutrientValue(data.sodium)"
				},
				carbohydrate: {
					type: Number,
					computed: "getNutrientValue(data.carbohydrate)"
				},
				dietaryFiber: {
					type: Number,
					computed: "getNutrientValue(data.dietaryFiber)"
				},
				sugars: {
					type: Number,
					computed: "getNutrientValue(data.sugars)"
				},
				protein: {
					type: Number,
					computed: "getNutrientValue(data.protein)"
				},
				vitaminA: {
					type: Number,
					computed: "getNutrientValue(data.vitaminA)"
				},
				vitaminC: {
					type: Number,
					computed: "getNutrientValue(data.vitaminC)"
				},
				iron: {
					type: Number,
					computed: "getNutrientValue(data.iron)"
				},
				calcium: {
					type: Number,
					computed: "getNutrientValue(data.calcium)"
				}
			},

			ready: function() {
				this.$.dailyReferenceValues.url = this.resolveUrl('data/us.json');
				this.$.dailyReferenceValues.generateRequest();
			},

			hresponse: function(request) {
				this.dailyValues = _.chain(request.detail.response.results)
						.indexBy(function (object) {
							return _.camelCase(object.food_value);
						})
						.mapValues('dv_value_numbers')
						.value();
			},

			getNutrientValue: function (nutrient) {
				if (!nutrient) return false;
				return {
					amount: nutrient,
					dailyReferenceValue: nutrient,
					referenceDailyIntakes: nutrient
				};
			}
		});
	</script>
</dom-module>
